#!/usr/bin/env bash

# â”€â”€â”€ PATHS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DIR="$(cd "$(dirname "$0")" && pwd)"
CORE="$DIR/sakura-cli"

# â”€â”€â”€ CHECKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
command -v gum >/dev/null || { echo "gum is not installed"; exit 1; }
[ -x "$CORE" ] || { echo "sakura-cli not found or not executable"; exit 1; }

# â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export GUM_THEME_FOREGROUND="#ff79c6"
export GUM_THEME_BACKGROUND="#0b0b0f"
export GUM_THEME_SELECTED_FOREGROUND="#0b0b0f"
export GUM_THEME_SELECTED_BACKGROUND="#ff79c6"
export GUM_THEME_BORDER_FOREGROUND="#ff79c6"
export GUM_THEME_CURSOR_FOREGROUND="#ff79c6"
export GUM_HELP_FOREGROUND="#0b0b0f"

# â”€â”€â”€ TERMINAL WIDTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COLS=$(tput cols)

# â”€â”€â”€ PERSISTENT OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OPT_QUALITY="best"
OPT_PLAYER="mpv"
OPT_MODE="sub"
OPT_SKIP_INTRO=0
OPT_NO_DETACH=0

# â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
header() {
  clear
  for i in {0..4}; do
    printf "\e[48;2;%d;%d;%dm%*s\e[0m\n" \
      255 \
      $((105 + (182 - 105) * i / 4)) \
      $((180 + (198 - 180) * i / 4)) \
      "$COLS" ""
  done

  SAKURA_TEXT=$(cat << "EOF"
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•
EOF
)

  # Braille sakura branch art (trimmed to fit neatly beside header)
  FLOWER=$(printf "\033[38;2;255;121;198m%s\033[0m" \
'                        
â €â €â €â €â €â €â €â €â €â£ â£¾â£¿â£§â£¼â£¿â£·â£„â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â£¼â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£§â €â €â €â €â €â €â €â €
â €â €â €â¢€â£€â£€â£€â£°â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£†â£€â£€â£€â¡€â €â €â €
â €â£´â£¾â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â ‹â ™â¢¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£·â£¦â €
â €â£™â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£§â €â €â£¼â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£‹â €
â£¿â£¿â£¿â£¿â£¿â£¿â£¿â â €â ˆâ »â ¿â €â €â ¿â Ÿâ â €â ˆâ£¿â£¿â£¿â£¿â£¿â£¿â£¿
â ˜â¢¿â£¿â£¿â£¿â£¿â£¿â£¦â£¤â£¤â£„â¡€â €â €â¢€â£ â£¤â£¤â£´â£¿â£¿â£¿â£¿â£¿â¡¿â ƒ
â €â €â ™â¢¿â£¿â£¿â£¿â£¿â£¿â ¿â ‹â €â£ â£„â €â ™â ¿â£¿â£¿â£¿â£¿â£¿â¡¿â ‹â €â €
â €â €â €â¢°â£¿â£¿â£¿â£¿â£¿â €â €â¢ â£¿â£¿â¡„â €â €â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €
â €â €â €â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¾â£¿â£¿â£¿â£¿â£·â£¿â£¿â£¿â£¿â£¿â£¿â£¿â €â €â €
â €â €â €â¢¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â €â €â €
â €â €â €â ˆâ ›â ›â£¿â£¿â£¿â£¿â£¿â¡¿â ›â ›â¢¿â£¿â£¿â£¿â£¿â£¿â ›â ›â â €â €â €
â €â €â €â €â €â €â ˜â ›â ›â ‰â â €â €â €â €â ˆâ ‰â ›â ›â ƒâ €â €â €â €â €â € ')

  HEADER_BOX=$(gum style \
    --border rounded \
    --align center \
    --padding "1 2" \
    --margin "1 0" \
    --border-foreground "#ff79c6" \
    --background "#0b0b0f" \
    "$SAKURA_TEXT
Anime Player & Downloader")

  FLOWER_STYLED=$(gum style \
    --align left \
    --foreground "#ff79c6" \
    --margin "1 1" \
    "$FLOWER")

  gum join --align center "$HEADER_BOX" "$FLOWER_STYLED"
}

status_bar() {
  local skip_icon="â­ skip:$([ "$OPT_SKIP_INTRO" = "1" ] && echo ON || echo OFF)"
  gum style \
    --border normal \
    --align center \
    --padding "0 2" \
    --border-foreground "#ff79c6" \
    --foreground "#f8f8f2" \
    "  ğŸ¬ $OPT_PLAYER   |   ğŸ $OPT_QUALITY   |   ğŸ—£ $OPT_MODE   |   $skip_icon  "
}

# â”€â”€â”€ BUILD FLAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
build_flags() {
  FLAGS=""
  [ "$OPT_PLAYER" = "vlc" ]    && FLAGS="$FLAGS --vlc"
  [ "$OPT_MODE"   = "dub" ]    && FLAGS="$FLAGS --dub"
  [ "$OPT_SKIP_INTRO" = "1" ]  && FLAGS="$FLAGS --skip"
  [ "$OPT_NO_DETACH"  = "1" ]  && FLAGS="$FLAGS --no-detach"
  [ "$OPT_QUALITY" != "best" ] && FLAGS="$FLAGS -q $OPT_QUALITY"
}

# â”€â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
watch_anime() {
  while true; do
    header; status_bar
    QUERY=$(gum input \
      --placeholder "Anime title..." \
      --prompt "â€ Search > " \
      --width 60) || return
    [ -z "$QUERY" ] && return
    build_flags
    # shellcheck disable=SC2086
    "$CORE" $FLAGS "$QUERY"
  done
}

continue_watching() {
  header; status_bar
  build_flags
  # shellcheck disable=SC2086
  "$CORE" $FLAGS --continue
}

download_anime() {
  while true; do
    header; status_bar
    QUERY=$(gum input \
      --placeholder "Anime title..." \
      --prompt "â€ Download > " \
      --width 60) || return
    [ -z "$QUERY" ] && return
    build_flags
    # shellcheck disable=SC2086
    "$CORE" -d $FLAGS "$QUERY"
  done
}

syncplay_anime() {
  while true; do
    header; status_bar
    QUERY=$(gum input \
      --placeholder "Anime title..." \
      --prompt "â€ Syncplay > " \
      --width 60) || return
    [ -z "$QUERY" ] && return
    build_flags
    # shellcheck disable=SC2086
    "$CORE" -s $FLAGS "$QUERY"
  done
}

show_status_check() {
  while true; do
    header
    QUERY=$(gum input \
      --placeholder "Anime title..." \
      --prompt "â€ Status > " \
      --width 60) || return
    [ -z "$QUERY" ] && return
    "$CORE" --nextep-countdown "$QUERY"
    echo ""
    gum confirm "Check another?" || return
  done
}

view_history() {
  header
  gum style --foreground "#ff79c6" --bold "  Watch History"
  echo ""
  "$CORE" --logview
  echo ""
  CHOICE=$(gum choose \
    --cursor "â€ " \
    "â† Back" \
    "ğŸ—‘ Delete History") || return
  case "$CHOICE" in
    "ğŸ—‘ Delete History")
      gum confirm "Delete ALL history?" && "$CORE" --delete
      ;;
  esac
}

play_downloads() {
  header
  status_bar
  build_flags
  # shellcheck disable=SC2086
  "$CORE" $FLAGS --local
}

settings_menu() {
  while true; do
    header
    echo ""
    gum style \
      --border rounded \
      --padding "0 2" \
      --border-foreground "#ff79c6" \
      --foreground "#f8f8f2" \
      "Player     : $OPT_PLAYER
Quality    : $OPT_QUALITY
Mode       : $OPT_MODE
Skip Intro : $([ "$OPT_SKIP_INTRO" = "1" ] && echo ON || echo OFF)
No Detach  : $([ "$OPT_NO_DETACH"  = "1" ] && echo ON || echo OFF)"
    echo ""
    SETTING=$(gum choose \
      --cursor "â€ " \
      "ğŸ¬ Player  [$OPT_PLAYER]" \
      "ğŸ Quality [$OPT_QUALITY]" \
      "ğŸ—£ Mode    [$OPT_MODE]" \
      "â­ Skip Intro [$([ "$OPT_SKIP_INTRO" = "1" ] && echo ON || echo OFF)]" \
      "ğŸ“Œ No Detach [$([ "$OPT_NO_DETACH" = "1" ] && echo ON || echo OFF)]" \
      "â† Back") || return
    case "$SETTING" in
      "ğŸ¬ Player"*)
        OPT_PLAYER=$(gum choose --cursor "â€ " "mpv" "vlc") || true ;;
      "ğŸ Quality"*)
        OPT_QUALITY=$(gum choose --cursor "â€ " "best" "1080p" "720p" "480p" "360p" "worst") || true ;;
      "ğŸ—£ Mode"*)
        OPT_MODE=$(gum choose --cursor "â€ " "sub" "dub") || true ;;
      "â­ Skip Intro"*)
        [ "$OPT_SKIP_INTRO" = "1" ] && OPT_SKIP_INTRO=0 || OPT_SKIP_INTRO=1 ;;
      "ğŸ“Œ No Detach"*)
        [ "$OPT_NO_DETACH" = "1" ] && OPT_NO_DETACH=0 || OPT_NO_DETACH=1 ;;
      "â† Back") return ;;
    esac
  done
}

# â”€â”€â”€ MAIN MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while true; do
  header
  status_bar
  echo ""

  CHOICE=$(gum choose \
    --cursor "â€ " \
    "â–¶  Watch Anime" \
    "â†º  Continue Watching" \
    "â¬‡  Download Anime" \
    "ğŸ“‚ Play Downloads" \
    "ğŸ”— Watch with Syncplay" \
    "â° Show Status Check" \
    "ğŸ“œ History & Logs" \
    "âš™  Settings" \
    "âŒ  Exit") || { clear; exit; }

  case "$CHOICE" in
    "â–¶  Watch Anime")          watch_anime ;;
    "â†º  Continue Watching")   continue_watching ;;
    "â¬‡  Download Anime")      download_anime ;;
    "ğŸ“‚ Play Downloads")      play_downloads ;;
    "ğŸ”— Watch with Syncplay")  syncplay_anime ;;
    "â° Show Status Check")    show_status_check ;;
    "ğŸ“œ History & Logs")       view_history ;;
    "âš™  Settings")            settings_menu ;;
    "âŒ  Exit")                clear; exit ;;
  esac
done
